import{_ as A,p as Y,q as V,C as P,b as _,o as h,w as f,G as I,e as w,j as u,c as H,a as r,ac as W,ad as T,V as U}from"./framework.BBXmkLIm.js";import{u as z,a as O,o as q}from"./index.C8Ip_Z1u.js";import{L as F,M as J,D as K,A as Q,U as Z,S as $}from"./theme.B9sJry8H.js";const y={loadingInstance:null,dialogInstance:null};function j(c="加载中..."){y.loadingInstance&&y.loadingInstance.hide(),c!==!1&&(y.loadingInstance=F({delay:0,fullscreen:!0,indicator:!0,inheritColor:!1,loading:!0,preventScrollThrough:!0,showOverlay:!0,size:"large",text:c,zIndex:3500}))}function ee(c){y.dialogInstance&&y.dialogInstance.destroy(),typeof c=="string"&&(c={body:c});const{theme:o="info",header:x,body:l,confirmBtn:v,onConfirm:C=()=>{}}=c,e=c.onConfirm?c.cancelBtn||void 0:null;y.dialogInstance=K({mode:"modal",placement:"center",theme:o,closeBtn:!1,destroyOnClose:!0,header:x,body:l,footer:!0,confirmBtn:v,confirmLoading:!1,confirmOnEnter:!0,cancelBtn:e,onConfirm:()=>{C(),y.dialogInstance.destroy()}})}function te(c){typeof c=="string"&&(c={content:c});const{theme:o="info",content:x,duration:l=1500}=c;J(o,{closeBtn:!0,content:x,icon:!0,placement:"center"},l)}const g={loading:j,dialog:ee,message:te},ne={style:{width:"100%"}},ae={key:3,class:"center"},le={__name:"ContactAngle",setup(c){g.loading("正在启动OpenCV.js计算机视觉模块，请稍候...");const o=Y(1),x=Y([]),l=Y(null),v=z(l),C=Y(0),e={cv:null,ctx:null,canvasScaling:0,matGray:null,imageData:null,rectXmax:null,rectYmax:null,rectXmin:null,rectYmin:null},{elementX:M,elementY:B}=O(l);q(l,S);const{stop:N}=V([l,v],a=>{const[t,n]=a;t&&n&&(N(),l.value.style.width=v.value.clientWidth+"px",U(()=>import("./opencv.DUTv8PWl.js").then(s=>s.o),[]).then(s=>{s.default.then(m=>{e.cv=m,g.loading(!1)})}))});async function D(a){try{if(a.length===0){o.value=1;return}g.loading("正在读取照片...");const t=URL.createObjectURL(a[0].raw),n=new Image;n.style.display="none",n.src=t,await n.decode(),e.canvasScaling=n.naturalWidth/v.value.clientWidth,l.value.style.height=n.naturalHeight/e.canvasScaling+"px";const i=e.cv.imread(n);n.remove(),e.matGray&&e.matGray.delete(),e.matGray=new e.cv.Mat,e.cv.cvtColor(i,e.matGray,e.cv.COLOR_RGBA2GRAY,0),e.cv.imshow(l.value,e.matGray),i.delete(),e.ctx=l.value.getContext("2d"),k(),e.imageData=e.ctx.getImageData(0,0,l.value.width,l.value.height),o.value=2,g.loading(!1)}catch(t){g.loading(!1),console.log("onPicChange()方法出错：",t),g.dialog({theme:"danger",header:"读取照片报错",body:t.message})}}function S(a){o.value<2||(o.value===2&&(e.rectXmax=null,e.rectYmax=null,e.rectXmin=null,e.rectYmin=null),e.ctx.putImageData(e.imageData,0,0))}function E(a){o.value===2&&G()}function G(){try{const a=M.value*e.canvasScaling,t=B.value*e.canvasScaling;if(!e.rectXmax){const p=l.value.width,d=l.value.height,X=Math.min(p/4,d/4);e.rectXmax=Math.min(a+X,p),e.rectYmax=Math.min(t+X,d),e.rectXmin=Math.max(a-X,0),e.rectYmin=Math.max(t-X,0),R();return}if(a===e.rectXmax||a===e.rectXmin||t===e.rectYmax||t===e.rectYmin)return;let n=0;if(a>e.rectXmax?e.rectXmax=a:a<e.rectXmin?e.rectXmin=a:n++,t>e.rectYmax?e.rectYmax=t:t<e.rectYmin?e.rectYmin=t:n++,n!==2){R();return}const i=(e.rectYmax-e.rectYmin)/(e.rectXmax-e.rectXmin),s=(t-e.rectYmin)/(a-e.rectXmin),m=(t-e.rectYmin)/(a-e.rectXmax);s>=i?m<=-i?e.rectYmax=t:e.rectXmin=a:m<=-i?e.rectXmax=a:e.rectYmin=t,R();return}catch(a){console.log("chooseRect()方法出错：",a),g.dialog({theme:"danger",header:"选框报错",body:a.message})}}function b(a,t=!1){try{if(!e.rectXmax){t&&(o.value=3);return}const n=e.rectXmax-e.rectXmin,i=e.rectYmax-e.rectYmin,s=new e.cv.Rect(e.rectXmin,e.rectYmin,n,i);S();let m=e.matGray.roi(s);e.cv.imshow(l.value,m),e.matGray.delete(),e.matGray=m,m=null,l.value.style.width=v.value.clientWidth+"px",e.canvasScaling=n/v.value.clientWidth,l.value.style.height=i/e.canvasScaling+"px",k(),e.imageData=e.ctx.getImageData(0,0,l.value.width,l.value.height),t&&(o.value=3)}catch(n){console.log("onSureRect()方法出错：",n),g.dialog({theme:"danger",header:"裁剪报错",body:n.message})}}function k(){e.ctx.strokeStyle="red",e.ctx.lineWidth=2*e.canvasScaling}function R(){e.ctx.putImageData(e.imageData,0,0),e.ctx.strokeRect(e.rectXmin,e.rectYmin,e.rectXmax-e.rectXmin,e.rectYmax-e.rectYmin)}function L(a){try{let t=new e.cv.Mat;e.cv.threshold(e.matGray,t,Number(a),255,e.cv.THRESH_BINARY);let n=new e.cv.MatVector,i=new e.cv.Mat;e.cv.findContours(t,n,i,e.cv.RETR_LIST,e.cv.CHAIN_APPROX_NONE),t.delete(),i.delete();let s=new e.cv.Mat;e.matGray.copyTo(s);const m=new e.cv.Scalar(255,0,0),p=1*e.canvasScaling;e.cv.drawContours(s,n,-1,m,p),e.cv.imshow(l.value,s),s.delete()}catch(t){console.log("chooseContour()方法出错：",t),g.dialog({theme:"danger",header:"轮廓查找操作报错",body:t.message})}}return(a,t)=>{const n=Q,i=Z,s=P("myButton"),m=$,p=P("MySpace");return h(),_(p,null,{default:f(()=>[I(n,{theme:"info",title:"功能简介"},{default:f(()=>t[4]||(t[4]=[r(" 1. 点击读取图片文件。读取的图片文件将直接灰度化。"),u("br",null,null,-1),r(" 2. 裁剪图片为合适的尺寸。短按控制边框；长按清空已有选框。"),u("br",null,null,-1),r(" 3. 选择基底线、液滴边缘线。 ")])),_:1,__:[4]}),o.value===1?(h(),_(n,{key:0,theme:"warning",title:"步骤1"},{default:f(()=>t[5]||(t[5]=[r(" 首先点击“点击上传图片”读取图片。"),u("br",null,null,-1),r(" 读取到的图片会自动进行灰度化渲染。 ")])),_:1,__:[5]})):w("",!0),I(i,{disabled:!1,class:"center",theme:"image",multiple:!1,draggable:!1,showImageFileName:!0,abridgeName:[3,8],files:x.value,"onUpdate:files":t[0]||(t[0]=d=>x.value=d),autoUpload:!1,sizeLimit:{size:10,unit:"MB"},onChange:D},null,8,["files"]),o.value===2?(h(),_(n,{key:1,theme:"warning",title:"步骤2"},{default:f(()=>t[6]||(t[6]=[r(" 接下来需要将图片裁剪为合适的尺寸。"),u("br",null,null,-1),r(" 短按可控制边框；长按可清空已有选框。"),u("br",null,null,-1),r(" 可通过下方“裁剪图片”按钮多次裁剪，直到满意后，点击下方“完成裁剪”按钮进入下一步。 ")])),_:1,__:[6]})):w("",!0),o.value===3?(h(),_(n,{key:2,theme:"warning",title:"步骤3"},{default:f(()=>t[7]||(t[7]=[r(" 接下来寻找固体基底及液滴的最佳轮廓。"),u("br",null,null,-1),r(" 调节滑轨可切换灰度值呈现的轮廓效果；长按可清空效果。 ")])),_:1,__:[7]})):w("",!0),u("div",ne,[W(u("canvas",{ref_key:"canvasRef",ref:l,onClick:E,style:{width:"0px",height:"0px"}},null,512),[[T,o.value>=2]])]),o.value===2?(h(),H("div",ae,[I(s,{onClick:t[1]||(t[1]=d=>{b(d,!1)}),block:!1},{default:f(()=>t[8]||(t[8]=[r(" 裁剪图片 ")])),_:1,__:[8]}),I(s,{onClick:t[2]||(t[2]=d=>{b(d,!0)}),block:!1,theme:"danger"},{default:f(()=>t[9]||(t[9]=[r(" 完成裁剪 ")])),_:1,__:[9]})])):w("",!0),o.value===3?(h(),_(m,{key:4,onChangeEnd:L,inputNumberProps:!1,label:!0,layout:"horizontal",marks:[0,85,170,255],min:0,max:255,step:1,modelValue:C.value,"onUpdate:modelValue":t[3]||(t[3]=d=>C.value=d)},null,8,["modelValue"])):w("",!0),t[11]||(t[11]=u("br",null,null,-1)),o.value===3?(h(),_(n,{key:5,theme:"error"},{default:f(()=>t[10]||(t[10]=[r(" 这个交互效果有待讨论改进，我想到的一些点："),u("br",null,null,-1),r(" 1. 滑轨这样是否可以？"),u("br",null,null,-1),r(" 2. 基底线和液滴线要分成2步查找。"),u("br",null,null,-1),r(" 3. 基底线必然要让学生选2点，然后拟合直线。然后可以结合识别到的轮廓线，对基底直线进行微调（微调权重又是个问题）。"),u("br",null,null,-1),r(" 4. 液滴轮廓线方面，选点的交互操作其实很困难啊。我想到都一个实现是：在基底线确定之后，可以纯粹通过滑轨找液滴轮廓——学生调好轮廓后，点击“确定液滴轮廓”，然后软件自动选取基底线上方的轮廓点作为“有效液滴轮廓点”，然后带着一大堆有效轮廓坐标点数据来拟合液滴。不过就怕“基底线上方的轮廓点”这个限制条件有隐患，一个大一点的光晕/噪点，人能看出来，计算机不懂啊，那数据就存在各种隐患了。"),u("br",null,null,-1),r(" 5. 还有没有什么好的交互、算法上的建议？ ")])),_:1,__:[10]})):w("",!0)]),_:1,__:[11]})}}},ie=A(le,[["__scopeId","data-v-321cbd4f"]]);export{ie as default};
