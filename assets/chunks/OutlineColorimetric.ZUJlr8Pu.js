import{D as xe,p as P,aw as Ce,v as ye,u as Me,q as j,$ as we,C as L,b as _,o as m,w,G as D,e as E,j as F,c as S,F as R,B,t as b,ac as Se,ad as ke,a as V,P as O}from"./framework.Cmgf5mhA.js";import{u as Te,m as x,a as X}from"./myFunc.B9q0cR1e.js";import{l as be,a as Ae,d as De}from"./opencvLoader.DfX4YSJS.js";import{A as _e,U as Re,S as Be,D as Pe}from"./theme.Dmfs0Tpn.js";const g={},p={},$={root:g,en:p};g.FunctionIntroductionTitle="操作方法";p.FunctionIntroductionTitle="Operation Method";g.FunctionIntroductionContent=["1. 读取所拍摄的样品图片。","2. 滑动阈值调节选框，并预览处理后的图片。","3. 可反复调整参数预览，直至参数合适，然后下载详细数据。"];p.FunctionIntroductionContent=["1. Read the sample image taken.","2. Slide the threshold adjustment box and preview the processed image.","3. Adjust the parameters repeatedly to preview until the parameters are suitable, and then download the detailed data."];g.SetpTitle="步骤";p.SetpTitle="Step ";g.Setp1Content=["首先点击“点击上传图片”读取图片。"];p.Setp1Content=["First click on the 'Click to upload image' to read the image."];g.Setp2Content=["接下来需要将图片裁剪为合适的尺寸。","点击/触控图片，可控制边框。","可通过下方“裁剪图片”按钮多次裁剪，直到满意后，点击下方“完成裁剪”按钮进入下一步。"];p.Setp2Content=["Next, you need to crop the image to the appropriate size.","Click/touch the image, press to control the border.","You can crop the image multiple times by clicking the 'Crop Image' button below, and click the 'Finish Cropping' button below to proceed to the next step after you are satisfied."];g.Setp3Content=["为方便采集数据，提供了[二值化阈值]、[近圆度]、[面积滤过率]、[圆径缩放]滑轨。","二值化即以0为黑，255为白。设定一个[二值化阈值]，对于灰度化处理后的照片，每个像素点高于阈值的均赋值为白(255)，低于阈值的均赋值为黑(0)。阈值越低(越黑)，则越多深色像素被定义为白；反之阈值越高(越白)，则越多浅色像素被定义为黑。","面积滤过率即对识别到的轮廓面积进行排序，过滤掉排序低于或高于阈值的轮廓。","圆径缩放即对识别到的轮廓的半径/直径进行缩放，缩放后可更准确地采集数据。建议为0.5。"];p.Setp3Content=["To facilitate data collection, [Binary Threshold], [Circularity], [Area Filter Rate], and [Diameter Scaling] sliders are provided.","Binarization means taking 0 as black and 255 as white. Set a [binarization threshold]. For the photos after grayscale processing, each pixel above the threshold is assigned a white value (255), and each pixel below the threshold is assigned a black value (0). The lower the threshold (the darker), the more dark pixels are defined as white. Conversely, the higher the threshold (the whiter), the more light-colored pixels are defined as black.","Area Filter Rate is to sort the recognized contour area and filter out the contours that are below or above the threshold.","Diameter Scaling is to scale the radius/diameter of the recognized contour. After scaling, data can be collected more accurately. It is recommended to be 0.5."];g.CutPictureButtonText="裁剪图片";p.CutPictureButtonText="Cut Picture";g.CutPictureCompleteButtonText="裁剪完成";p.CutPictureCompleteButtonText="Complete Cut";g.ThresholdParamsLabel=["二值化阈值","面积滤过率(%)","圆径缩放"];p.ThresholdParamsLabel=["Binary Threshold","Area Filter Rate (%)","Diameter Scaling"];g.DownloadDataButtonLabel="下载数据";p.DownloadDataButtonLabel="Download Data";g.OpenCVLoadingContent="正在启动OpenCV.js计算机视觉模块，请稍候...";p.OpenCVLoadingContent="Starting OpenCV.js computer vision module, please wait...";g.ErrorDialogTitle="程序报错";p.ErrorDialogTitle="Program Error";g.ErrorDialogContent="欢迎向软件开发人员（13611580728 司承运）主动告知此bug，以便及时修复。";p.ErrorDialogContent="Welcome to inform the software development personnel (+8613611580728 SI_Cheng-Yun) of this bug actively so that it can be repaired in time. ";g.PicLoadingContent="正在读取照片...";p.PicLoadingContent="Loading picture...";const Ee={style:{width:"100%"}},Ie={key:3,class:"center"},ze={__name:"OutlineColorimetric",setup(Le){const f=xe($.root),C=P(1),N=P([]),M=Ce("canvasRef"),A=P([]),z=[[50,0,200,[0,50,100,150,200],!1,1],[[0,100],0,100,[0,25,50,75,100],!0,1],[.5,0,1,[0,.25,.5,.75,1],!1,.1]],J=P(!0),h={cv:null,canvasStyleWidth:null,filename:null,ctx:null,canvasScaling:0,matGray:null,imageData:null,imageBitmap:null,rect:{xMin:null,yMin:null,xMax:null,yMax:null},contourAoa:[],circleAreaArr:[]},{elementX:K,elementY:Q}=Te(M);ye(()=>{const t=Me().localeIndex.value;if(t!=="root"&&(f.value=$[t]),x.loading(f.value.OpenCVLoadingContent),window.addEventListener("beforeunload",G),M.value)h.ctx=M.value.getContext("2d",{willReadFrequently:!0});else{const{stop:e}=j(M,r=>{r&&(e(),h.ctx=r.getContext("2d",{willReadFrequently:!0}))})}be().then(e=>{h.cv=e,x.loading(!1)}),j(C,Z)});function Z(){O(t).catch(e=>{x.error("nextTickFocusOnCanvas()报错：",e,T)});function t(){M.value.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}}we(()=>{window.removeEventListener("beforeunload",G)});function G(t){t.preventDefault(),t.returnValue=!1}function T(t){x.dialog({theme:"danger",header:f.value.ErrorDialogTitle,body:f.value.ErrorDialogContent+t})}function ee(){try{C.value===2&&(re(),ie())}catch(t){x.error("onCanvasClick()报错：",t,T)}}function te(){C.value=1}async function ne(t){try{if(t.length===0){te();return}x.loading(f.value.PicLoadingContent);const{imageBitmap:e}=h;h.filename=t[0].name;const r=await window.createImageBitmap(t[0].raw);e==null||e.close(),h.imageBitmap=r,oe(),x.loading(!1)}catch(e){x.loading(!1),x.error("onPicChange()方法出错：",e,T)}}function oe(){W(),C.value=2,O(I).catch(t=>{x.error("taskToStep2().nextTick()报错：",t,T)})}function W(){const t=h.rect;t.xMin=null,t.yMin=null,t.xMax=null,t.yMax=null}function I(){const t=M.value,{ctx:e,imageBitmap:r}=h;t.width=r.width,t.height=r.height;const n=t.parentElement.clientWidth;h.canvasStyleWidth=n,t.style.width=n+"px";const o=t.width/n;h.canvasScaling=o,t.style.height=t.height/o+"px",e.drawImage(r,0,0),ae()}function ae(){const{ctx:t,canvasScaling:e}=h;t.strokeStyle="red",t.lineWidth=2*e,t.fillStyle="rgba(0, 0, 0, 0.7)"}function re(){const{rect:e,canvasScaling:r}=h,n=K.value*r,o=Q.value*r;if(!e.xMax){const i=M.value,c=i.width*.8*.5,s=i.height*.8*.5;e.xMax=Math.min(n+c,i.width),e.yMax=Math.min(o+s,i.height),e.xMin=Math.max(n-c,0),e.yMin=Math.max(o-s,0);return}if(n===e.xMin||n===e.xMax||o===e.yMin||o===e.yMax)return;let a=0;if(n<e.xMin?e.xMin=n:n>e.xMax?e.xMax=n:a++,o<e.yMin?e.yMin=o:o>e.yMax?e.yMax=o:a++,a<2)return;const l=(e.yMax-e.yMin)/(e.xMax-e.xMin),u=(o-e.yMin)/(n-e.xMin),d=(o-e.yMin)/(n-e.xMax);u>=l?d<=-l?e.yMax=o:e.xMin=n:d<=-l?e.xMax=n:e.yMin=o}function ie(){const{rect:t,ctx:e,imageBitmap:r}=h,n=M.value,o=t.xMax-t.xMin,a=t.yMax-t.yMin;e.drawImage(r,0,0),e.fillRect(0,0,n.width,n.height),e.drawImage(r,t.xMin,t.yMin,o,a,t.xMin,t.yMin,o,a),e.strokeRect(t.xMin,t.yMin,o,a)}async function U(t){try{const{rect:e,imageBitmap:r}=h,n=M.value;if(e.xMax){const o=await window.createImageBitmap(r,e.xMin,e.yMin,e.xMax-e.xMin,e.yMax-e.yMin);r==null||r.close(),h.imageBitmap=o,I(),W()}if(t===!0){const{ctx:o,cv:a,matGray:l,imageBitmap:{width:u,height:d}}=h;h.imageData=o.getImageData(0,0,u,d);const i=a.imread(n);l==null||l.delete(),h.matGray=new a.Mat,a.cvtColor(i,h.matGray,a.COLOR_RGBA2GRAY,0),i.delete(),le()}}catch(e){x.error("onSureRect()方法出错：",e,T)}}function le(){J.value=!0,ce(),C.value=3,O(q).catch(t=>{x.error("taskToStep3().nextTick()报错：",t,T)})}function ce(){const t=A.value;if(t.length===0)A.value=e(z);else{const r=e(z);for(let n=0;n<t.length;n++)r[n][0]=t[n][0];A.value=r}function e(r){const n=[];for(let o=0;o<r.length;o++)n.push([...r[o]]);return n}}function se(t){try{t===0?ue():de()}catch(e){x.error("onSlideChange()报错：",e,T)}}const ue=X(q,500,!0),de=X(H,500,!0);function q(){const t=A.value[0][0],{cv:e,matGray:r}=h,n=new e.Mat;e.threshold(r,n,t,255,e.THRESH_BINARY);const o=new e.MatVector,a=new e.Mat;e.findContours(n,o,a,e.RETR_EXTERNAL,e.CHAIN_APPROX_SIMPLE);const l=o.size(),{contourAoa:u,circleAreaArr:d}=h;u.length=0,d.length=0;e:for(let i=0;i<l;i++){const c=o.get(i),{m00:s}=e.moments(c,!0);if(s<=1)continue e;const y=e.minEnclosingCircle(c);u.push([s,y.center.x,y.center.y,y.radius]),d.push(s),c.delete()}d.sort((i,c)=>i-c),n.delete(),o.delete(),a.delete(),H()}function H(){const[,[[t,e]],[r]]=A.value,{ctx:n,contourAoa:o,circleAreaArr:a}=h,l=a.length,u=Math.ceil(l*t/100),d=Math.floor(l*e/100),i=a[u],c=a[d];I();e:for(const s of o)if(s[0]<i||s[0]>c){s[4]=!1;continue e}else s[4]=!0,n.beginPath(),n.arc(s[1],s[2],s[3]*r,0,2*Math.PI),n.stroke()}function he(){try{const t=fe(),e=me(t);ve(e)}catch(t){x.error("onDownloadData()报错：",t,T)}}function fe(){const{contourAoa:t}=h,e=A.value[2][0],r=[],n=[];e:for(const a of t){if(a[4]===!1)continue e;const l=a[1],u=a[1]-a[3],d=a[1]+a[3],i=a[2],c=a[2]-a[3],s=a[2]+a[3],y=r.length;let v=0;t:for(;v<y;){if(l>=r[v][0]&&l<=r[v][1]){u<r[v][0]&&(r[v][0]=u),d>r[v][1]&&(r[v][1]=d);break t}v++}v===y&&r.push([u,d]);const Y=n.length;let k=0;t:for(;k<Y;){if(i>=n[k][0]&&i<=n[k][1]){c<n[k][0]&&(n[k][0]=c),s>n[k][1]&&(n[k][1]=s);break t}k++}k===Y&&n.push([c,s])}r.sort((a,l)=>a[0]-l[0]),n.sort((a,l)=>a[0]-l[0]);const o=[];for(let a=0;a<n.length;a++)o.push([]);e:for(const a of t){if(a[4]===!1)continue e;const l=a[1],u=a[2];for(let d=0;d<n.length;d++)if(u>=n[d][0]&&u<=n[d][1])for(let i=0;i<r.length;i++)l>=r[i][0]&&l<=r[i][1]&&(o[d][i]=[a[1],a[2],a[3]*e])}return o}function me(t){const{width:e,data:r}=h.imageData,n=[];for(let o=0;o<6;o++)n.push([]);for(let o=0;o<t.length;o++){for(let a=0;a<6;a++)n[a].push([]);e:for(let a=0;a<t[o].length;a++){const l=t[o][a];if(!l)continue e;const u=ge(l),d=[[],[],[]];for(const i of u){const[c,s]=i,y=(s*e+c)*4;for(let v=0;v<3;v++)d[v].push(r[y+v])}for(let i=0;i<d.length;i++){const[c,s]=pe(d[i]);n[i*2][o][a]=c,n[i*2+1][o][a]=s}}}return n}function ge(t){const[e,r,n]=t,o=n*n,a=[[Math.round(e),Math.round(r)]];for(let l=1;l<=n;l++)e:for(let u=1;u<=n;u++){if(l*l+u*u>o)continue e;const i=Math.round(e+l),c=Math.round(r+u),s=Math.round(e-l),y=Math.round(r-u);a.push([i,c],[i,y],[s,c],[s,y])}return a}function pe(t){let e=0;for(let o=0;o<t.length;o++)e=e+t[o];const r=e/t.length;e=0;for(let o=0;o<t.length;o++)e=e+(t[o]-r)**2;const n=Math.sqrt(e/(t.length-1));return[r,n]}function ve(t){const e=new Map,r=["R-Ave","R-SD","G-Ave","G-SD","B-Ave","B-SD"];for(let o=0;o<r.length;o++)e.set(r[o],t[o]);const n=Ae(e);De(n,"data.xlsx")}return(t,e)=>{const r=_e,n=Re,o=L("myButton"),a=Be,l=Pe,u=L("mySpace"),d=L("MySpace");return m(),_(d,null,{default:w(()=>[D(r,{theme:"info",title:f.value.FunctionIntroductionTitle},{default:w(()=>[(m(!0),S(R,null,B(f.value.FunctionIntroductionContent,(i,c)=>(m(),S("div",{key:c},b(i),1))),128))]),_:1},8,["title"]),C.value===1?(m(),_(r,{key:0,theme:"warning",title:f.value.SetpTitle+"1"},{default:w(()=>[(m(!0),S(R,null,B(f.value.Setp1Content,(i,c)=>(m(),S("div",{key:c},b(i),1))),128))]),_:1},8,["title"])):E("",!0),D(n,{disabled:!1,class:"center",theme:"image",multiple:!1,draggable:!1,showImageFileName:!0,abridgeName:[3,8],files:N.value,"onUpdate:files":e[0]||(e[0]=i=>N.value=i),autoUpload:!1,sizeLimit:{size:10,unit:"MB"},onChange:ne},null,8,["files"]),C.value===2?(m(),_(r,{key:1,theme:"warning",title:f.value.SetpTitle+"2"},{default:w(()=>[(m(!0),S(R,null,B(f.value.Setp2Content,(i,c)=>(m(),S("div",{key:c},b(i),1))),128))]),_:1},8,["title"])):E("",!0),C.value===3?(m(),_(r,{key:2,theme:"warning",title:f.value.SetpTitle+"3"},{default:w(()=>[(m(!0),S(R,null,B(f.value.Setp3Content,(i,c)=>(m(),S("div",{key:c},b(i),1))),128))]),_:1},8,["title"])):E("",!0),F("div",Ee,[Se(F("canvas",{ref_key:"canvasRef",ref:M,onClick:ee},null,512),[[ke,C.value>=2]])]),C.value===2?(m(),S("div",Ie,[D(o,{onClick:e[1]||(e[1]=i=>U(!1)),"data-is-determine-str":"false",block:!1},{default:w(()=>[V(b(f.value.CutPictureButtonText),1)]),_:1}),D(o,{onClick:e[2]||(e[2]=i=>U(!0)),"data-is-determine-str":"true",block:!1,theme:"danger"},{default:w(()=>[V(b(f.value.CutPictureCompleteButtonText),1)]),_:1})])):C.value===3?(m(),_(u,{key:4,size:"small"},{default:w(()=>[(m(!0),S(R,null,B(A.value,(i,c)=>(m(),_(u,{key:c,size:"small"},{default:w(()=>[F("div",null,b(f.value.ThresholdParamsLabel[c]),1),D(a,{onChange:s=>se(c),modelValue:i[0],"onUpdate:modelValue":s=>i[0]=s,range:i[4],min:i[1],max:i[2],step:i[5],marks:i[3],inputNumberProps:!1,label:!0,layout:"horizontal"},null,8,["onChange","modelValue","onUpdate:modelValue","range","min","max","step","marks"]),D(l)]),_:2},1024))),128)),D(o,{onClick:he,block:!0,theme:"danger"},{default:w(()=>[V(b(f.value.DownloadDataButtonLabel),1)]),_:1})]),_:1})):E("",!0)]),_:1})}}};export{ze as default};
